{{define "content"}}
<div>
  <div class="d-lg-flex">
    <div class="me-lg-3 mb-4" style="min-width: 220px">
      <ul class="nav nav-pills flex-column mb-auto">
        <li>
          <a href="?tab=targets" class="nav-link {{ if eq .tab "targets" }}active{{else}}link-body-emphasis{{ end }}">
            <i class="bi bi-server me-2"></i>
            Targets
          </a>
        </li>
        <li class="nav-item">
          <a href="?tab=recordings" class="nav-link {{ if eq .tab "recordings" }}active{{else}}link-body-emphasis{{ end }}">
            <i class="bi bi-terminal-fill me-2"></i>
            Recordings
          </a>
        </li>
        <li>
          <a href="?tab=users" class="nav-link {{ if eq .tab "users" }}active{{else}}link-body-emphasis{{ end }}">
            <i class="bi bi-person-fill me-2"></i>
            Users
          </a>
        </li>
      </ul>
    </div>
    <div class="flex-grow-1">
      {{ if eq .tab "recordings" }}
      <h2 class="h4 mb-0">Recordings</h2>
      <hr />
      <form class="mb-4" method="GET" action="/admin">
        <div class="row g-2">
          <div class="col-md-3 form-floating">
            <input type="text" name="tab" value="recordings" hidden>
            <input
              type="text"
              class="form-control"
              name="user"
              value="{{ .search.user }}"
              id="user"
              placeholder="Search by User"
            />
            <label for="user">Search by User</label>
          </div>
          <div class="col-md-3 form-floating">
            <input
              type="text"
              class="form-control"
              name="target"
              value="{{ .search.target }}"
              placeholder="Search by Target"
            />
            <label>Search by Target</label>
          </div>
          <div class="col-md-3 form-floating">
            <input
              type="date"
              class="form-control"
              name="after"
              placeholder="After"
              value="{{ .search.after }}"
              placeholder="After"
            />
            <label>From</label>
          </div>
          <div class="col-md-3 form-floating" form-floating>
            <input
              type="date"
              class="form-control"
              name="before"
              placeholder="Before"
              value="{{ .search.before }}"
              placeholder="Before"
            />
            <label>To</label>
          </div>
        </div>
        <div class="mt-3" form-floating>
          <button type="submit" class="btn btn-primary">Search</button>
          <a href="/admin?tab=recordings" class="btn btn-secondary">Clear Filters</a>
        </div>
      </form>

      <div class="list-group list-group-flush">
        {{ range.recordings }}

        <a
          class="list-group-item list-group-item-action d-flex justify-content-between align-items-center"
          href="/recordings/{{ .ID }}"
        >
          {{if .Status }}
            <div>
              <i class="me-2 bi bi-exclamation-circle-fill"></i>
              <span class="badge text-bg-secondary">{{.IP}}</span> failed to connect
            </div>
          {{ else }}
            <div>
              {{ .User.Username }} <span class="badge text-bg-secondary">{{.IP}}</span> connected to {{ .Target.Name }}
            </div>
          {{ end }}
          <span class="text-secondary">{{ duration .CreatedAt }}</span>
        </a>
        {{ else }}
        <div class="list-group-item text-center">
          <i class="bi bi-exclamation-circle me-2"></i>
          No recordings
        </div>

        {{ end }}
      </div>

      <div class="mt-3 d-flex justify-content-center">
        <ul class="pagination">
          <li class="page-item {{ if not .hasPrev }}disabled{{ end }}">
            <a
              class="page-link"
              href="/admin?tab=recordings&page={{ .prevPage }}&user={{ .search.user }}&target={{ .search.target }}&after={{ .search.after }}&before={{ .search.before }}"
            >
              Previous
            </a>
          </li>
          <li class="page-item {{ if not .hasNext }}disabled{{ end }}">
            <a
              class="page-link"
              href="/admin?tab=recordings&page={{ .nextPage }}&user={{ .search.user }}&target={{ .search.target }}&after={{ .search.after }}&before={{ .search.before }}"
            >
              Next
            </a>
          </li>
        </ul>
      </div>

      {{ end }}

      {{ if eq .tab "targets" }}

      <div class="d-flex justify-content-between align-items-end">
        <div>
          <h2 class="h4 mb-0">Targets</h2>
        </div>
        <div class="d-flex gap-2">
          <button
            type="button"
            class="btn btn-outline-primary btn-sm"
            data-bs-toggle="modal"
            data-bs-target="#groupModal"
            data-action="create"
          >
            Add group
          </button>
          <button
            type="button"
            class="btn btn-success btn-sm"
            data-bs-toggle="modal"
            data-bs-target="#targetModal"
            data-action="create"
          >
            Add new target
          </button>
        </div>
      </div>
      <hr />

      <div id="groupsContainer" class="mb-4">
        {{ range .targetGroups }}
        <div class="group-block list-group-item p-0" data-group-block data-group-id="{{.ID}}" draggable="true">
          <div class="group-row d-flex align-items-center px-3 py-3" draggable="true" data-group-id="{{.ID}}">
            <span class="me-3 text-secondary fs-5" style="cursor: grab;">&#9776;</span>
            <div class="flex-grow-1">
              <div class="fw-semibold">{{.Title}}</div>
              <div class="text-secondary small">{{.Description}}</div>
            </div>
            <div class="d-flex gap-2">
              <button
                type="button"
                class="btn btn-sm btn-secondary"
                data-bs-toggle="modal"
                data-bs-target="#groupModal"
                data-action="update"
                data-id="{{.ID}}"
                data-title="{{.Title}}"
                data-description="{{.Description}}"
              >
                <i class="bi bi-pencil"></i>
                Edit
              </button>
              <button
                type="button"
                class="btn btn-sm btn-danger"
                data-bs-toggle="modal"
                data-bs-target="#deleteGroupModal"
                data-id="{{.ID}}"
                data-title="{{.Title}}"
              >
                <i class="bi bi-trash"></i>
                Delete
              </button>
            </div>
          </div>
          <div class="list-group" data-target-list data-group-id="{{.ID}}">
            {{ range .Targets }}
            <div
              class="list-group-item d-flex align-items-center target-row"
              draggable="true"
              data-target-id="{{.ID}}"
              data-group-id="{{.TargetGroupID}}"
              data-name="{{.Name}}"
              data-host="{{.Host}}"
              data-port="{{.Port}}"
              data-user="{{.User}}"
              data-desc="{{.Description}}"
            >
              <span class="me-3 text-secondary" style="cursor: grab;">&#8942;</span>
              <div class="flex-grow-1">
                <div class="fw-semibold">{{.Name}}</div>
                <div class="text-secondary small line-clamp">{{.Description}}</div>
                <div class="font-monospace small text-body-secondary">
                  {{.User}}@{{.Host}}:{{.Port}}
                </div>
              </div>
            </div>
            {{ else }}
            <div class="list-group-item text-secondary small empty-placeholder">No targets in this group.</div>
            {{ end }}
          </div>
        </div>
        {{ end }}
      </div>

      <div class="group-block list-group-item p-0" data-group-block data-group-id="">
        <div class="group-row d-flex align-items-center px-3 py-2">
          <span class="me-3 text-secondary fs-5">&#9776;</span>
          <div class="flex-grow-1">
            <div class="fw-semibold">Ungrouped</div>
          </div>
        </div>
        <div class="list-group" data-target-list data-group-id="">
          {{ range .ungroupedTargets }}
          <div
            class="list-group-item d-flex align-items-center target-row"
            draggable="true"
            data-target-id="{{.ID}}"
            data-group-id=""
          >
            <span class="me-3 text-secondary" style="cursor: grab;">&#8942;</span>
            <div class="flex-grow-1">
              <div class="fw-semibold">{{.Name}}</div>
              <div class="text-secondary small line-clamp">{{.Description}}</div>
              <div class="font-monospace small text-body-secondary">
                {{.User}}@{{.Host}}:{{.Port}}
              </div>
            </div>
          </div>
          {{ else }}
          <div class="list-group-item text-secondary small empty-placeholder">No targets in this group.</div>
          {{ end }}
        </div>
      </div>
      {{ end }}

      {{ if eq .tab "users" }}
      <h2 class="h4 mb-0">Users</h2>
      <hr />

      <div class="list-group">
        {{ range.users }}
        <div class="list-group-item p-3">
          <div class="d-flex mb-2 align-items-center justify-content-between">
            <span>
              <strong>
                {{ .Username }}
              </strong>
              #{{.ID}}
            </span>
            
            <button
              type="button"
              class="btn-close"
              aria-label="Close"
              data-bs-toggle="modal"
              data-bs-target="#deleteUserModal"
              data-id="{{.ID}}"
              data-username="{{.Username}}"
            ></button>
          </div>
          <div class="mb-4">
            {{ range .SSOCredentials }}
              <p class="mb-1">Login by <strong>{{.ProviderName}}</strong> <span class="badge text-bg-secondary font-monospace rounded-pill">{{.Subject}}</span></p>
            {{ end }}
          </div>
          <p class="mb-0 text-body-secondary">Created at {{ .CreatedAt.Format "Jan 2, 2006 (timezone MST)" }}</p>
          <p class="mb-0 text-body-secondary">Last login {{ duration .LastLoginAt }}</p>
        </div>
        {{ else }}
        <div class="list-group-item text-center">
          <i class="bi bi-exclamation-circle me-2"></i>
          No users.
        </div>
        {{ end }}
      </div>

      <div class="mt-3 d-flex justify-content-center">
        <ul class="pagination">
          <li class="page-item {{ if not .hasPrev }}disabled{{ end }}">
            <a
              class="page-link"
              href="/admin?tab=users&page={{ .prevPage }}&user={{ .search.user }}&target={{ .search.target }}&after={{ .search.after }}&before={{ .search.before }}"
            >
              Previous
            </a>
          </li>
          <li class="page-item {{ if not .hasNext }}disabled{{ end }}">
            <a
              class="page-link"
              href="/admin?tab=users&page={{ .nextPage }}&user={{ .search.user }}&target={{ .search.target }}&after={{ .search.after }}&before={{ .search.before }}"
            >
              Next
            </a>
          </li>
        </ul>
      </div>

      {{ end }}
    </div>
  </div>
</div>


{{ if eq .tab "targets" }}
<!-- 添加/更改服务器的模态框 -->
<div class="modal fade" id="targetModal" tabindex="-1" aria-labelledby="targetModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="targetModalLabel">Add Target</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
  <form id="targetForm" method="post">
    <div class="modal-body">
      <div class="mb-3 form-floating">
        <input type="text" class="form-control" id="targetName" name="name" required />
        <label for="targetName" class="form-label">Name</label>
          </div>
          <div class="mb-3 form-floating">
            <input type="text" class="form-control" id="targetDesc" name="description" required />
            <label for="targetDesc" class="form-label">Description</label>
          </div>
          <div class="mb-3 form-floating">
            <input type="text" class="form-control" id="targetHost" name="host" required />
            <label for="targetHost" class="form-label">Host</label>
          </div>
          <div class="mb-3 form-floating">
            <input type="number" class="form-control" id="targetPort" name="port" required />
            <label for="targetPort" class="form-label">Port</label>
          </div>
          <div class="mb-3 form-floating">
            <input type="text" class="form-control" id="targetUser" name="user" required />
            <label for="targetUser" class="form-label">User</label>
          </div>
          <div class="form-floating">
            <select class="form-select" id="targetGroup" name="groupId">
              <option value="">No group</option>
              {{ range .targetGroups }}
              <option value="{{.ID}}">{{.Title}}</option>
              {{ end }}
            </select>
            <label for="targetGroup" class="form-label">Group</label>
          </div>
    </div>
    <div class="modal-footer">
      <button type="button" class="btn btn-danger me-auto d-none" id="targetDeleteInModal" data-bs-toggle="modal" data-bs-target="#deleteTargetModal" data-bs-dismiss="modal">Delete</button>
      <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
      <button type="submit" class="btn btn-primary">OK</button>
    </div>
  </form>
</div>
  </div>
</div>

<!-- 删除服务器的模态框 -->
<div
  class="modal fade"
  id="deleteTargetModal"
  tabindex="-1"
  aria-labelledby="deleteTargetModalLabel"
  aria-hidden="true"
>
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="deleteTargetModalLabel">Delete Target</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p>
          Are you sure you want to delete target
          <strong id="deleteTargetName"></strong>
          ?
        </p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <form id="deleteForm" method="post" class="d-inline">
          <button type="submit" class="btn btn-danger">Delete</button>
        </form>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="groupModal" tabindex="-1" aria-labelledby="groupModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="groupModalLabel">Add Group</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form id="groupForm" method="post">
        <div class="modal-body">
          <div class="mb-3 form-floating">
            <input type="text" class="form-control" id="groupTitle" name="title" required />
            <label for="groupTitle" class="form-label">Title</label>
          </div>
          <div class="mb-3 form-floating">
            <input type="text" class="form-control" id="groupDescription" name="description" />
            <label for="groupDescription" class="form-label">Description</label>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">OK</button>
        </div>
      </form>
    </div>
  </div>
</div>

<div
  class="modal fade"
  id="deleteGroupModal"
  tabindex="-1"
  aria-labelledby="deleteGroupModalLabel"
  aria-hidden="true"
>
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="deleteGroupModalLabel">Delete Group</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p>
          Are you sure you want to delete group
          <strong id="deleteGroupTitle"></strong>
          ?
        </p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <form id="deleteGroupForm" method="post" class="d-inline">
          <button type="submit" class="btn btn-danger">Delete</button>
        </form>
      </div>
    </div>
  </div>
</div>

<script>
  const postJSON = async (url, payload) => {
    const res = await fetch(url, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload),
    });
    if (!res.ok) throw new Error(await res.text());
    return res.json();
  };

  const targetModal = document.getElementById('targetModal');
  const targetForm = document.getElementById('targetForm');
  const deleteBtn = document.getElementById('targetDeleteInModal');

  const fillTargetModal = (action, data) => {
    const modalTitle = targetModal.querySelector('.modal-title');
    if (action === 'create') {
      modalTitle.textContent = 'Add Target';
      targetForm.action = '/target';
      document.getElementById('targetName').value = '';
      document.getElementById('targetDesc').value = '';
      document.getElementById('targetHost').value = '';
      document.getElementById('targetPort').value = '';
      document.getElementById('targetUser').value = '';
      document.getElementById('targetGroup').value = '';
      deleteBtn.classList.add('d-none');
    } else {
      modalTitle.textContent = 'Edit Target';
      targetForm.action = '/target/update/' + data.id;
      document.getElementById('targetName').value = data.name || '';
      document.getElementById('targetHost').value = data.host || '';
      document.getElementById('targetPort').value = data.port || '';
      document.getElementById('targetUser').value = data.user || '';
      document.getElementById('targetDesc').value = data.desc || '';
      document.getElementById('targetGroup').value = data.group || '';
      deleteBtn.classList.remove('d-none');
      deleteBtn.setAttribute('data-id', data.id);
      deleteBtn.setAttribute('data-name', data.name || '');
    }
  };

  targetModal.addEventListener('show.bs.modal', function (event) {
    const button = event.relatedTarget;
    if (!button) return;
    const action = button.getAttribute('data-action') || 'create';
    const data = {
      id: button.getAttribute('data-id'),
      name: button.getAttribute('data-name'),
      host: button.getAttribute('data-host'),
      port: button.getAttribute('data-port'),
      user: button.getAttribute('data-user'),
      desc: button.getAttribute('data-desc'),
      group: button.getAttribute('data-group'),
    };
    fillTargetModal(action, data);
  });

  // 当 deleteTargetModal 显示时，设置表单 action 和显示要删除的服务器名称
  const deleteTargetModal = document.getElementById('deleteTargetModal');
  deleteTargetModal.addEventListener('show.bs.modal', function (event) {
    const trigger = event.relatedTarget;
    const id = trigger.getAttribute('data-id');
    const name = trigger.getAttribute('data-name');

    const deleteForm = document.getElementById('deleteForm');
    deleteForm.action = '/target/delete/' + id;

    document.getElementById('deleteTargetName').textContent = name;
  });

  const groupModal = document.getElementById('groupModal');
  groupModal.addEventListener('show.bs.modal', function (event) {
    const button = event.relatedTarget;
    const action = button.getAttribute('data-action');
    const modalTitle = groupModal.querySelector('.modal-title');
    const groupForm = document.getElementById('groupForm');

    if (action === 'create') {
      modalTitle.textContent = 'Add Group';
      groupForm.action = '/target-group';
      document.getElementById('groupTitle').value = '';
      document.getElementById('groupDescription').value = '';
    } else if (action === 'update') {
      const id = button.getAttribute('data-id');
      const title = button.getAttribute('data-title');
      const description = button.getAttribute('data-description');

      modalTitle.textContent = 'Edit Group';
      groupForm.action = '/target-group/update/' + id;
      document.getElementById('groupTitle').value = title;
      document.getElementById('groupDescription').value = description;
    }
  });

  const deleteGroupModal = document.getElementById('deleteGroupModal');
  deleteGroupModal.addEventListener('show.bs.modal', function (event) {
    const button = event.relatedTarget;
    const id = button.getAttribute('data-id');
    const title = button.getAttribute('data-title');

    const deleteForm = document.getElementById('deleteGroupForm');
    deleteForm.action = '/target-group/delete/' + id;

    document.getElementById('deleteGroupTitle').textContent = title;
  });

  // 原生拖拽：分组排序
  const groupContainer = document.getElementById('groupsContainer');
  let draggedGroup = null;

  const handleGroupDragStart = (e) => {
    draggedGroup = e.currentTarget.closest('[data-group-block]');
    e.dataTransfer.effectAllowed = 'move';
    e.currentTarget.classList.add('opacity-50');
  };

  const handleGroupDragEnd = (e) => {
    e.currentTarget.classList.remove('opacity-50');
    draggedGroup = null;
  };

  const handleGroupDragOver = (e) => {
    e.preventDefault();
    const targetBlock = e.target.closest('[data-group-block]');
    if (!targetBlock || targetBlock === draggedGroup || targetBlock.parentNode !== groupContainer) return;
    const rect = targetBlock.getBoundingClientRect();
    const before = e.clientY < rect.top + rect.height / 2;
    if (before) {
      groupContainer.insertBefore(draggedGroup, targetBlock);
    } else {
      groupContainer.insertBefore(draggedGroup, targetBlock.nextSibling);
    }
  };

  const saveGroupOrder = async () => {
    const ids = Array.from(groupContainer.querySelectorAll('[data-group-block]'))
      .map((el) => el.getAttribute('data-group-id'))
      .filter((id) => id)
      .map((id) => parseInt(id, 10)); // 排除未分组块，并转为数字
    try {
      await postJSON('/target-group/reorder', { groupIds: ids });
    } catch (err) {
      console.error(err);
    }
  };

  groupContainer?.addEventListener('dragover', handleGroupDragOver);
  groupContainer?.addEventListener('drop', (e) => {
    e.preventDefault();
    saveGroupOrder();
  });
  groupContainer?.querySelectorAll('[data-group-block][draggable="true"] .group-row').forEach((row) => {
    row.addEventListener('dragstart', handleGroupDragStart);
    row.addEventListener('dragend', (e) => {
      handleGroupDragEnd(e);
      saveGroupOrder();
    });
  });

  // 原生拖拽：目标排序与跨组移动
  let draggedTarget = null;

  const handleTargetDragStart = (e) => {
    draggedTarget = e.currentTarget;
    e.dataTransfer.effectAllowed = 'move';
    e.currentTarget.classList.add('opacity-50');
  };

  const handleTargetDragEnd = (e) => {
    e.currentTarget.classList.remove('opacity-50');
    draggedTarget = null;
  };

  const handleTargetDragOver = (e) => {
    if (!draggedTarget) return;
    e.preventDefault();
    const targetRow = e.target.closest('.target-row');
    const list = e.target.closest('[data-target-list]');
    if (!list) return;
    if (targetRow && targetRow !== draggedTarget) {
      const rect = targetRow.getBoundingClientRect();
      const before = e.clientY < rect.top + rect.height / 2;
      if (before) {
        list.insertBefore(draggedTarget, targetRow);
      } else {
        list.insertBefore(draggedTarget, targetRow.nextSibling);
      }
    } else if (!targetRow) {
      // drop inside list but not on item -> append
      list.appendChild(draggedTarget);
    }
  };

  const handleTargetDrop = (e) => {
    if (!draggedTarget) return;
    e.preventDefault();
    const list = e.target.closest('[data-target-list]');
    if (list && draggedTarget.parentNode !== list) {
      list.appendChild(draggedTarget);
      draggedTarget.setAttribute('data-group-id', list.getAttribute('data-group-id') || '');
      draggedTarget.setAttribute('data-group', list.getAttribute('data-group-id') || '');
    }
    refreshEmptyPlaceholders();
    saveTargetOrder();
  };

  const refreshEmptyPlaceholders = () => {
    document.querySelectorAll('[data-target-list]').forEach((list) => {
      const hasTargets = list.querySelector('.target-row') !== null;
      const placeholder = list.querySelector('.empty-placeholder');
      if (hasTargets && placeholder) {
        placeholder.remove();
      } else if (!hasTargets && !placeholder) {
        const ph = document.createElement('div');
        ph.className = 'list-group-item text-secondary small empty-placeholder';
        ph.textContent = 'No targets in this group.';
        list.appendChild(ph);
      }
    });
  };

  const collectTargetOrderPayload = () => {
    const groupsPayload = [];
    document.querySelectorAll('[data-group-block]').forEach((block) => {
      const groupId = block.getAttribute('data-group-id');
      const list = block.querySelector('[data-target-list]');
      const targetIds = Array.from(list.querySelectorAll('[data-target-id]')).map((el) =>
        parseInt(el.getAttribute('data-target-id'))
      );
      if (groupId) {
        groupsPayload.push({ groupId: parseInt(groupId), targetIds: targetIds });
      }
    });
    const ungroupedList = document.querySelector('[data-target-list][data-group-id=""]');
    const ungrouped = ungroupedList
      ? Array.from(ungroupedList.querySelectorAll('[data-target-id]')).map((el) =>
          parseInt(el.getAttribute('data-target-id'))
        )
      : [];
    return { groups: groupsPayload, ungrouped: ungrouped };
  };

  const saveTargetOrder = async () => {
    const payload = collectTargetOrderPayload();
    try {
      await postJSON('/target/reorder', payload);
    } catch (err) {
      console.error(err);
    }
  };

  document.querySelectorAll('.target-row').forEach((row) => {
    row.addEventListener('dragstart', handleTargetDragStart);
    row.addEventListener('dragend', handleTargetDragEnd);
    row.addEventListener('click', () => {
      if (draggedTarget) return; // 避免拖动后误触
      const data = {
        id: row.getAttribute('data-target-id'),
        name: row.getAttribute('data-name'),
        host: row.getAttribute('data-host'),
        port: row.getAttribute('data-port'),
        user: row.getAttribute('data-user'),
        desc: row.getAttribute('data-desc'),
        group: row.getAttribute('data-group-id') || '',
      };
      fillTargetModal('update', data);
      bootstrap.Modal.getOrCreateInstance(targetModal).show();
    });
  });
  document.querySelectorAll('[data-target-list]').forEach((list) => {
    list.addEventListener('dragover', handleTargetDragOver);
    list.addEventListener('drop', handleTargetDrop);
  });

  refreshEmptyPlaceholders();
</script>
{{ end }}

{{ if eq .tab "users" }}
<!-- 删除用户的模态框 -->
<div
  class="modal fade"
  id="deleteUserModal"
  tabindex="-1"
  aria-labelledby="deleteUserModalLabel"
>
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="deleteUserModalLabel">Delete User</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p>
          Are you sure you want to delete user
          <strong id="deleteUsername"></strong>
          ?
        </p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <form id="deleteForm" method="post" class="d-inline">
          <button type="submit" class="btn btn-danger">Delete</button>
        </form>
      </div>
    </div>
  </div>
</div>
<script>
  const deleteUserModal = document.getElementById('deleteUserModal');
  deleteUserModal.addEventListener('show.bs.modal', function (event) {
    const button = event.relatedTarget;
    const id = button.getAttribute('data-id');
    const username = button.getAttribute('data-username');

    const deleteForm = document.getElementById('deleteForm');
    deleteForm.action = '/user/delete/' + id;

    document.getElementById('deleteUsername').textContent = username;
  });
</script>

{{ end }}

{{ end }}
